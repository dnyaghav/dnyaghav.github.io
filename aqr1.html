<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advanced QR Code Generator</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- QRCode Styling (supports PNG/SVG, dots, logo, gradients) -->
  <script src="https://cdn.jsdelivr.net/npm/qr-code-styling@1.6.0/lib/qr-code-styling.js"></script>
  <style>
    body { background: #0f172a; color: #e2e8f0; }
    .card { border: none; border-radius: 1rem; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card-header { background: transparent; border-bottom: 1px dashed rgba(255,255,255,.1); }
    .form-label { font-weight: 600; }
    .qr-wrap { min-height: 320px; display: grid; place-items: center; background: #0b1024; border-radius: 1rem; }
    .footer-note { font-size: .85rem; opacity: .8; }
    .btn-soft { background: rgba(255,255,255,.08); border: 1px solid rgba(255,255,255,.15); color: #e2e8f0; }
    .btn-soft:hover { background: rgba(255,255,255,.12); color: #fff; }
    .divider { height: 1px; background: linear-gradient(90deg, transparent, rgba(255,255,255,.15), transparent); margin: 1rem 0; }
    a { color: #93c5fd; }
  </style>
</head>
<body>
  <div class="container py-4 py-md-5">
    <div class="row g-4">
      <div class="col-lg-5">
        <div class="card bg-dark text-light">
          <div class="card-header">
            <h1 class="h4 mb-0">Advanced QR Code Generator</h1>
          </div>
          <div class="card-body">
            <div class="mb-3">
              <label for="qrText" class="form-label">Text / URL</label>
              <textarea id="qrText" class="form-control" rows="3" placeholder="Type the content to encode...">https://example.com</textarea>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <label class="form-label" for="size">Size (px)</label>
                <input type="range" class="form-range" id="size" min="160" max="1024" step="16" value="320">
                <div class="small text-secondary"><span id="sizeVal">320</span> px</div>
              </div>
              <div class="col-6">
                <label class="form-label" for="margin">Margin</label>
                <input type="range" class="form-range" id="margin" min="0" max="24" step="1" value="8">
                <div class="small text-secondary"><span id="marginVal">8</span> px</div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-6">
                <label class="form-label" for="ecc">Error Correction</label>
                <select id="ecc" class="form-select">
                  <option value="L">L (7%)</option>
                  <option value="M" selected>M (15%)</option>
                  <option value="Q">Q (25%)</option>
                  <option value="H">H (30%)</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="encoding">Character Encoding</label>
                <select id="encoding" class="form-select">
                  <option value="UTF-8" selected>UTF-8</option>
                  <option value="ISO-8859-1">ISO-8859-1</option>
                </select>
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-6">
                <label class="form-label" for="fg">Foreground</label>
                <input type="color" id="fg" value="#111827" class="form-control form-control-color">
              </div>
              <div class="col-6">
                <label class="form-label" for="bg">Background</label>
                <input type="color" id="bg" value="#ffffff" class="form-control form-control-color">
              </div>
            </div>

            <div class="row g-3 mt-1">
              <div class="col-6">
                <label class="form-label" for="dotsStyle">Dots Style</label>
                <select id="dotsStyle" class="form-select">
                  <option value="square" selected>Square</option>
                  <option value="dots">Dots</option>
                  <option value="rounded">Rounded</option>
                  <option value="extra-rounded">Extra Rounded</option>
                  <option value="classy">Classy</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="cornersStyle">Corners Style</label>
                <select id="cornersStyle" class="form-select">
                  <option value="square">Square</option>
                  <option value="extra-rounded" selected>Extra Rounded</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row g-3 align-items-end">
              <div class="col-8">
                <label class="form-label" for="logoInput">Center Logo (PNG/JPG/SVG)</label>
                <input class="form-control" type="file" id="logoInput" accept="image/*,image/svg+xml">
              </div>
              <div class="col-4">
                <label class="form-label" for="logoSize">Logo Size (%)</label>
                <input type="range" class="form-range" id="logoSize" min="10" max="40" step="1" value="20">
                <div class="small text-secondary"><span id="logoSizeVal">20</span>%</div>
              </div>
            </div>
            <div class="form-check mt-2">
              <input class="form-check-input" type="checkbox" id="logoBg">
              <label class="form-check-label" for="logoBg">Add white logo background (for dark dots)</label>
            </div>

            <div class="divider"></div>

            <div class="row g-3">
              <div class="col-6">
                <label class="form-label" for="format">Download Format</label>
                <select id="format" class="form-select">
                  <option value="png" selected>PNG</option>
                  <option value="svg">SVG</option>
                  <option value="jpeg">JPEG</option>
                  <option value="webp">WEBP</option>
                </select>
              </div>
              <div class="col-6">
                <label class="form-label" for="filename">Filename</label>
                <input id="filename" class="form-control" value="qr-code" />
              </div>
            </div>

            <div class="d-grid gap-2 mt-4">
              <button class="btn btn-primary" id="btnGenerate">Generate</button>
              <div class="d-flex gap-2">
                <button class="btn btn-success flex-fill" id="btnDownload">Download</button>
                <button class="btn btn-soft flex-fill" id="btnCopy">Copy to Clipboard</button>
                <button class="btn btn-outline-warning flex-fill" id="btnReset">Reset</button>
              </div>
            </div>

            <p class="footer-note mt-3 mb-0">
              Tip: Use higher error correction (Q/H) if you add a logo or busy background. Larger size yields sharper prints.
            </p>
          </div>
        </div>
      </div>

      <div class="col-lg-7">
        <div class="card bg-dark text-light h-100">
          <div class="card-header d-flex align-items-center justify-content-between">
            <span class="h5 mb-0">Preview</span>
            <div class="d-flex gap-2">
              <button class="btn btn-soft btn-sm" id="btnInvert">Invert Colors</button>
              <button class="btn btn-soft btn-sm" id="btnRandom">Randomize</button>
            </div>
          </div>
          <div class="card-body">
            <div class="qr-wrap" id="qrWrap"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // --- Helpers ---
    const $ = (sel) => document.querySelector(sel);
    const textEl = $('#qrText');
    const sizeEl = $('#size');
    const marginEl = $('#margin');
    const eccEl = $('#ecc');
    const encodingEl = $('#encoding');
    const fgEl = $('#fg');
    const bgEl = $('#bg');
    const dotsStyleEl = $('#dotsStyle');
    const cornersStyleEl = $('#cornersStyle');
    const logoInputEl = $('#logoInput');
    const logoSizeEl = $('#logoSize');
    const logoBgEl = $('#logoBg');
    const formatEl = $('#format');
    const filenameEl = $('#filename');

    const sizeVal = $('#sizeVal');
    const marginVal = $('#marginVal');
    const logoSizeVal = $('#logoSizeVal');

    const wrap = $('#qrWrap');

    function dataUrlFromFile(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function randItem(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
    function randHex(){ return '#'+Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0'); }

    // --- QR Code Styling instance ---
    let currentLogoDataUrl = null;
    const qr = new QRCodeStyling({
      width: parseInt(sizeEl.value, 10),
      height: parseInt(sizeEl.value, 10),
      type: 'canvas', // can export to any format later
      data: textEl.value,
      margin: parseInt(marginEl.value, 10),
      qrOptions: {
        errorCorrectionLevel: eccEl.value,
        mode: 'Byte',
        version: 0
      },
      imageOptions: {
        saveAsBlob: false,
        crossOrigin: 'anonymous',
        margin: 0,
      },
      image: currentLogoDataUrl,
      dotsOptions: {
        type: dotsStyleEl.value,
        color: fgEl.value
      },
      backgroundOptions: {
        color: bgEl.value
      },
      cornersSquareOptions: {
        type: cornersStyleEl.value,
        color: fgEl.value
      },
      cornersDotOptions: {
        color: fgEl.value
      }
    });

    qr.append(wrap);

    async function updateQR() {
      const size = parseInt(sizeEl.value, 10);
      const margin = parseInt(marginEl.value, 10);
      const ecc = eccEl.value;
      const fg = fgEl.value;
      const bg = bgEl.value;
      const dotsType = dotsStyleEl.value;
      const cornersType = cornersStyleEl.value;

      const image = currentLogoDataUrl || undefined;
      const imageSizeRatio = parseInt(logoSizeEl.value, 10) / 100; // 0.1 - 0.4

      // If logo background is toggled, wrap the logo with a white rounded rect using an offscreen canvas
      let finalImage = image;
      if (image && logoBgEl.checked) {
        finalImage = await addWhitePaddingToImage(image, size, imageSizeRatio);
      }

      qr.update({
        width: size,
        height: size,
        data: textEl.value,
        margin,
        qrOptions: { errorCorrectionLevel: ecc, mode: 'Byte' },
        image: finalImage,
        imageOptions: { imageSize: imageSizeRatio },
        dotsOptions: { type: dotsType, color: fg },
        backgroundOptions: { color: bg },
        cornersSquareOptions: { type: cornersType, color: fg },
        cornersDotOptions: { color: fg }
      });
    }

    async function addWhitePaddingToImage(srcDataUrl, qrSize, ratio) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          const logoSize = Math.floor(qrSize * ratio);
          const pad = Math.max(6, Math.floor(logoSize * 0.18));
          const canvas = document.createElement('canvas');
          canvas.width = logoSize + pad*2;
          canvas.height = logoSize + pad*2;
          const ctx = canvas.getContext('2d');

          // rounded rect background
          const r = Math.floor((logoSize + pad*2) * 0.18);
          roundRect(ctx, 0, 0, canvas.width, canvas.height, r);
          ctx.fillStyle = '#ffffff';
          ctx.fill();

          // draw logo centered
          ctx.drawImage(img, pad, pad, logoSize, logoSize);
          resolve(canvas.toDataURL());
        };
        img.crossOrigin = 'anonymous';
        img.src = srcDataUrl;
      });
    }

    function roundRect(ctx, x, y, w, h, r) {
      r = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+r, y);
      ctx.arcTo(x+w, y, x+w, y+h, r);
      ctx.arcTo(x+w, y+h, x, y+h, r);
      ctx.arcTo(x, y+h, x, y, r);
      ctx.arcTo(x, y, x+w, y, r);
      ctx.closePath();
    }

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn.apply(this,args), ms); }; }

    const debouncedUpdate = debounce(updateQR, 120);

    // --- Event bindings ---
    [textEl, sizeEl, marginEl, eccEl, encodingEl, fgEl, bgEl, dotsStyleEl, cornersStyleEl, logoSizeEl, logoBgEl].forEach(el => {
      el.addEventListener('input', (e) => {
        if (e.target === sizeEl) sizeVal.textContent = sizeEl.value;
        if (e.target === marginEl) marginVal.textContent = marginEl.value;
        if (e.target === logoSizeEl) logoSizeVal.textContent = logoSizeEl.value;
        debouncedUpdate();
      });
      el.addEventListener('change', debouncedUpdate);
    });

    logoInputEl.addEventListener('change', async () => {
      if (logoInputEl.files && logoInputEl.files[0]) {
        currentLogoDataUrl = await dataUrlFromFile(logoInputEl.files[0]);
      } else {
        currentLogoDataUrl = null;
      }
      updateQR();
    });

    $('#btnGenerate').addEventListener('click', (e)=>{ e.preventDefault(); updateQR(); });

    $('#btnDownload').addEventListener('click', async (e)=>{
      e.preventDefault();
      const format = formatEl.value; // png, jpeg, webp, svg
      const name = (filenameEl.value || 'qr-code').replace(/\s+/g,'-');
      await qr.download({ name, extension: format });
    });

    $('#btnCopy').addEventListener('click', async (e)=>{
      e.preventDefault();
      // Export to PNG blob and copy to clipboard
      const blob = await qr.getRawData('png');
      if (navigator.clipboard && 'write' in navigator.clipboard) {
        await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]);
        toast('Copied PNG to clipboard');
      } else {
        toast('Clipboard API not supported in this browser');
      }
    });

    $('#btnReset').addEventListener('click', (e)=>{
      e.preventDefault();
      textEl.value = 'https://example.com';
      sizeEl.value = 320; sizeVal.textContent = '320';
      marginEl.value = 8; marginVal.textContent = '8';
      eccEl.value = 'M';
      encodingEl.value = 'UTF-8';
      fgEl.value = '#111827';
      bgEl.value = '#ffffff';
      dotsStyleEl.value = 'square';
      cornersStyleEl.value = 'extra-rounded';
      logoInputEl.value = '';
      logoSizeEl.value = 20; logoSizeVal.textContent = '20';
      logoBgEl.checked = false;
      currentLogoDataUrl = null;
      formatEl.value = 'png';
      filenameEl.value = 'qr-code';
      updateQR();
    });

    $('#btnInvert').addEventListener('click', ()=>{
      const oldBg = bgEl.value; bgEl.value = fgEl.value; fgEl.value = oldBg; updateQR();
    });

    $('#btnRandom').addEventListener('click', ()=>{
      fgEl.value = randHex();
      bgEl.value = randHex();
      dotsStyleEl.value = randItem(['square','dots','rounded','extra-rounded','classy']);
      cornersStyleEl.value = randItem(['square','extra-rounded']);
      eccEl.value = randItem(['L','M','Q','H']);
      updateQR();
    });

    function toast(msg){
      const el = document.createElement('div');
      el.className = 'position-fixed top-0 start-50 translate-middle-x mt-3 z-3';
      el.innerHTML = `<div class="alert alert-success shadow" role="alert">${msg}</div>`;
      document.body.appendChild(el);
      setTimeout(()=> el.remove(), 1600);
    }

    // Initial render
    updateQR();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>